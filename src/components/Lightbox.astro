---
// Lightbox component for viewing images in a modal overlay with navigation
---

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox-overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="lightbox-backdrop"></div>

  <!-- Navigation Arrows -->
  <button
    type="button"
    class="lightbox-nav lightbox-prev"
    aria-label="Previous photo"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>

  <button
    type="button"
    class="lightbox-nav lightbox-next"
    aria-label="Next photo"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  <!-- Content Container -->
  <div class="lightbox-content">
    <!-- Close Button -->
    <button
      type="button"
      class="lightbox-close"
      aria-label="Close lightbox"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <!-- Image Container -->
    <div class="lightbox-image-container">
      <!-- Loading spinner -->
      <div id="lightbox-loader" class="lightbox-loader">
        <div class="lightbox-spinner"></div>
      </div>
      <!-- LQIP placeholder (blurred) -->
      <img
        id="lightbox-lqip"
        src=""
        alt=""
        class="lightbox-lqip"
      />
      <!-- Full resolution image -->
      <img
        id="lightbox-image"
        src=""
        alt=""
        class="lightbox-image"
      />
    </div>

    <!-- Photo Details -->
    <div class="lightbox-details">
      <div class="lightbox-title-line">
        <span id="lightbox-title" class="lightbox-title"></span>
        <span id="lightbox-location" class="lightbox-location"></span>
      </div>
      <p id="lightbox-description" class="lightbox-description"></p>
    </div>
  </div>
</div>

<style>
  .lightbox-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
    padding: 20px;
  }

  .lightbox-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

  .lightbox-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.95);
    cursor: pointer;
  }

  .lightbox-content {
    position: relative;
    z-index: 10000;
    max-width: 1200px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .lightbox-image-container {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  /* Loading spinner */
  .lightbox-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    display: none;
  }

  .lightbox-loader.active {
    display: block;
  }

  .lightbox-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* LQIP blur-up placeholder */
  .lightbox-lqip {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1.1);
    max-width: 100%;
    max-height: 70vh;
    width: auto;
    height: auto;
    object-fit: contain;
    filter: blur(20px);
    opacity: 1;
    transition: opacity 0.4s ease-out;
    z-index: 1;
  }

  .lightbox-lqip.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .lightbox-image {
    position: relative;
    z-index: 2;
    max-width: 100%;
    max-height: 70vh;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    transform: scale(0.95);
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
  }

  .lightbox-image.loading {
    opacity: 0;
  }

  .lightbox-overlay.active .lightbox-image {
    transform: scale(1);
  }

  .lightbox-close {
    position: absolute;
    top: -60px;
    right: 0;
    z-index: 10001;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: all 0.2s ease;
    padding: 0;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
  }

  .lightbox-close:active {
    transform: scale(0.95);
  }

  .lightbox-close svg {
    width: 24px;
    height: 24px;
  }

  /* Navigation Arrows */
  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10001;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: all 0.2s ease;
    padding: 0;
  }

  .lightbox-prev {
    left: 20px;
  }

  .lightbox-next {
    right: 20px;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-50%) scale(1.1);
  }

  .lightbox-nav:active {
    transform: translateY(-50%) scale(0.95);
  }

  .lightbox-nav.hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Photo Details */
  .lightbox-details {
    width: 100%;
    max-width: 800px;
    color: white;
    text-align: center;
    padding: 0 20px;
  }

  .lightbox-title-line {
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .lightbox-title {
    color: white;
  }

  .lightbox-location {
    color: rgba(255, 255, 255, 0.8);
  }

  .lightbox-location::before {
    content: "|";
    margin-right: 12px;
    color: rgba(255, 255, 255, 0.5);
  }

  .lightbox-description {
    font-size: 1rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .lightbox-overlay {
      padding: 10px;
    }

    .lightbox-image {
      max-height: 60vh;
    }

    .lightbox-close {
      top: -50px;
      width: 44px;
      height: 44px;
    }

    .lightbox-nav {
      width: 48px;
      height: 48px;
    }

    .lightbox-prev {
      left: 10px;
    }

    .lightbox-next {
      right: 10px;
    }

    .lightbox-title-line {
      font-size: 1.1rem;
      flex-direction: column;
      gap: 4px;
    }

    .lightbox-location::before {
      content: "";
      margin-right: 0;
    }

    .lightbox-description {
      font-size: 0.9rem;
    }
  }

  /* Prevent body scroll when lightbox is active */
  body.lightbox-active {
    overflow: hidden;
  }
</style>

<script>
  // Lightbox functionality with navigation
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const lightboxLoader = document.getElementById('lightbox-loader');
  const lightboxLqip = document.getElementById('lightbox-lqip') as HTMLImageElement;
  const lightboxTitle = document.getElementById('lightbox-title');
  const lightboxLocation = document.getElementById('lightbox-location');
  const lightboxDescription = document.getElementById('lightbox-description');
  const lightboxClose = document.querySelector('.lightbox-close');
  const lightboxBackdrop = document.querySelector('.lightbox-backdrop');
  const lightboxPrev = document.querySelector('.lightbox-prev');
  const lightboxNext = document.querySelector('.lightbox-next');

  // Store photos array and current index
  let photos: Array<{
    image: string;
    original?: string;
    lqip?: string;
    alt: string;
    title: string;
    location?: string;
    description?: string;
  }> = [];
  let currentIndex = 0;

  // Prefetch cache to avoid duplicate requests
  const prefetchedUrls = new Set<string>();

  function prefetchImage(url: string) {
    if (!url || prefetchedUrls.has(url)) return;
    const img = new Image();
    img.src = url;
    prefetchedUrls.add(url);
  }

  function prefetchAdjacentImages() {
    if (currentIndex > 0) {
      prefetchImage(photos[currentIndex - 1].image);
    }
    if (currentIndex < photos.length - 1) {
      prefetchImage(photos[currentIndex + 1].image);
    }
  }

  // Function to update photo display
  function updatePhoto(index: number) {
    if (!photos.length || index < 0 || index >= photos.length) return;

    currentIndex = index;
    const photo = photos[currentIndex];

    // Show LQIP immediately (blur-up placeholder)
    if (lightboxLqip && photo.lqip) {
      lightboxLqip.src = photo.lqip;
      lightboxLqip.classList.remove('hidden');
    }

    // Show loader, hide main image during load
    lightboxLoader?.classList.add('active');
    lightboxImage?.classList.add('loading');

    // Update image with load handler
    if (lightboxImage) {
      lightboxImage.onload = () => {
        lightboxLoader?.classList.remove('active');
        lightboxImage?.classList.remove('loading');
        lightboxLqip?.classList.add('hidden');
      };
      lightboxImage.onerror = () => {
        lightboxLoader?.classList.remove('active');
        lightboxImage?.classList.remove('loading');
      };
      lightboxImage.src = photo.image;
      lightboxImage.alt = photo.alt;
    }

    // Update details
    if (lightboxTitle) {
      lightboxTitle.textContent = photo.title;
    }

    if (lightboxLocation) {
      lightboxLocation.textContent = photo.location || '';
      lightboxLocation.style.display = photo.location ? 'inline' : 'none';
    }

    if (lightboxDescription) {
      lightboxDescription.textContent = photo.description || '';
      lightboxDescription.style.display = photo.description ? 'block' : 'none';
    }

    // Update navigation button visibility
    if (lightboxPrev) {
      if (currentIndex === 0) {
        lightboxPrev.classList.add('hidden');
      } else {
        lightboxPrev.classList.remove('hidden');
      }
    }

    if (lightboxNext) {
      if (currentIndex === photos.length - 1) {
        lightboxNext.classList.add('hidden');
      } else {
        lightboxNext.classList.remove('hidden');
      }
    }

    // Prefetch adjacent images for faster navigation
    prefetchAdjacentImages();
  }

  // Function to open lightbox
  function openLightbox(photosArray: typeof photos, startIndex: number = 0) {
    if (!lightbox || !photosArray.length) return;

    photos = photosArray;
    updatePhoto(startIndex);

    lightbox.classList.add('active');
    lightbox.setAttribute('aria-hidden', 'false');
    document.body.classList.add('lightbox-active');
  }

  // Function to close lightbox
  function closeLightbox() {
    if (!lightbox) return;

    lightbox.classList.remove('active');
    lightbox.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('lightbox-active');

    // Clear prefetch cache when lightbox closes
    prefetchedUrls.clear();
  }

  // Function to go to previous photo
  function previousPhoto() {
    if (currentIndex > 0) {
      updatePhoto(currentIndex - 1);
    }
  }

  // Function to go to next photo
  function nextPhoto() {
    if (currentIndex < photos.length - 1) {
      updatePhoto(currentIndex + 1);
    }
  }

  // Close button click
  lightboxClose?.addEventListener('click', closeLightbox);

  // Backdrop click
  lightboxBackdrop?.addEventListener('click', closeLightbox);

  // Navigation button clicks
  lightboxPrev?.addEventListener('click', previousPhoto);
  lightboxNext?.addEventListener('click', nextPhoto);

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('active')) return;

    switch (e.key) {
      case 'Escape':
        closeLightbox();
        break;
      case 'ArrowLeft':
        previousPhoto();
        break;
      case 'ArrowRight':
        nextPhoto();
        break;
    }
  });

  // Expose openLightbox function globally for use in other components
  (window as any).openLightbox = openLightbox;

  // Auto-initialize photo grid items
  function initPhotoGridItems() {
    const photoButtons = document.querySelectorAll('.photo-grid-item');
    if (photoButtons.length === 0) return;

    // Track preloaded images for hover preloading
    const preloadedUrls = new Set<string>();

    // Group photos by their data-group attribute (or treat all as one group if not set)
    const photosByGroup: Record<string, Array<{
      image: string;
      original: string;
      lqip: string;
      alt: string;
      title: string;
      location?: string;
      description?: string;
    }>> = {};

    photoButtons.forEach((button) => {
      const btn = button as HTMLButtonElement;
      const group = btn.dataset.group || '_all';
      const locationParts = [btn.dataset.locationName, btn.dataset.countryName].filter(Boolean);

      const photoData = {
        image: btn.dataset.lightboxSrc || '',
        original: btn.dataset.originalSrc || '',
        lqip: btn.dataset.lqipSrc || '',
        alt: btn.dataset.alt || '',
        title: btn.dataset.caption || '',
        location: locationParts.join(', '),
        description: '',
      };

      if (!photosByGroup[group]) {
        photosByGroup[group] = [];
      }
      photosByGroup[group].push(photoData);
    });

    // Add click and hover handlers
    photoButtons.forEach((photo) => {
      // Click handler to open lightbox
      photo.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const group = button.dataset.group || '_all';
        const clickedIndex = parseInt(button.dataset.index || '0', 10);

        if ((window as any).openLightbox && photosByGroup[group]) {
          (window as any).openLightbox(photosByGroup[group], clickedIndex);
        }
      });

      // Hover handler to preload full image
      photo.addEventListener('mouseenter', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const lightboxSrc = button.dataset.lightboxSrc;

        if (lightboxSrc && !preloadedUrls.has(lightboxSrc)) {
          const img = new Image();
          img.src = lightboxSrc;
          preloadedUrls.add(lightboxSrc);
        }
      }, { passive: true });
    });
  }

  // Initialize on page load
  initPhotoGridItems();

  // Re-initialize on navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initPhotoGridItems);
</script>
