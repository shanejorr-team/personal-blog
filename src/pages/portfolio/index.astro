---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import Lightbox from '../../components/Lightbox.astro';

// Get all portfolio collections
const allPortfolio = await getCollection('portfolio');
const sortedPortfolio = allPortfolio.sort((a, b) => a.data.order - b.data.order);

// Group by category
const categories = {
  nature: sortedPortfolio.filter(p => p.data.category === 'nature'),
  street: sortedPortfolio.filter(p => p.data.category === 'street'),
  concert: sortedPortfolio.filter(p => p.data.category === 'concert'),
  other: sortedPortfolio.filter(p => p.data.category === 'other'),
};

const categoryInfo = {
  nature: {
    title: 'Nature',
    description: 'Landscapes, wildlife, and natural wonders',
  },
  street: {
    title: 'Street Photography',
    description: 'Candid moments and urban life',
  },
  concert: {
    title: 'Concert Photography',
    description: 'Live music and performance',
  },
  other: {
    title: 'Other',
    description: 'Various photography projects',
  },
};

// Get current category filter
const currentCategory = Astro.url.searchParams.get('category') as keyof typeof categories | null;

// Extract all unique countries
const countriesSet = new Set<string>();
allPortfolio.forEach(portfolio => {
  portfolio.data.images.forEach(image => {
    if (image.country) {
      countriesSet.add(image.country);
    }
  });
});
const countries = Array.from(countriesSet).sort();
---

<BaseLayout
  title="Photography Portfolio"
  description="Browse curated collections of nature, street, and concert photography."
>
  <div class="container mx-auto px-4 py-12">
    <Breadcrumbs items={[{ label: 'Portfolio' }]} />

    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Photography Portfolio</h1>
      <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Curated collections of my best work
      </p>
    </div>

    <!-- Category Filter -->
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-center mb-4">Browse by Photo Type</h3>
      <div class="flex flex-wrap gap-4 justify-center">
        <a
          href="/portfolio"
          class={`px-6 py-3 rounded-lg font-medium transition-colors ${
            !currentCategory
              ? 'bg-blue-600 text-white'
              : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'
          }`}
        >
          All
        </a>
        {Object.entries(categoryInfo).map(([key, info]) => (
          <a
            href={`/portfolio?category=${key}`}
            class={`px-6 py-3 rounded-lg font-medium transition-colors ${
              currentCategory === key
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'
            }`}
          >
            {info.title}
          </a>
        ))}
      </div>
    </div>

    <!-- Country Filter -->
    {countries.length > 0 && (
      <div class="mb-12">
        <h3 class="text-lg font-semibold text-center mb-4">Browse by Country</h3>
        <div class="flex flex-wrap gap-4 justify-center">
          {countries.map(country => (
            <a
              href={`/portfolio/${country.toLowerCase().replace(/\s+/g, '-')}`}
              class="px-6 py-3 rounded-lg font-medium transition-colors bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
            >
              {country}
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Portfolio Galleries -->
    {Object.entries(categories).map(([categoryKey, galleries]) => {
      const key = categoryKey as keyof typeof categories;
      if (currentCategory && currentCategory !== key) return null;
      if (galleries.length === 0) return null;

      // Flatten all images from all galleries in this category
      const allImages = galleries.flatMap((gallery, galleryIndex) =>
        gallery.data.images.map((image, imageIndex) => ({
          ...image,
          galleryId: gallery.id,
          galleryIndex,
          imageIndex,
        }))
      );

      return (
        <section class="mb-20" id={key}>
          <div class="mb-8">
            <h2 class="text-3xl font-bold mb-2">{categoryInfo[key].title}</h2>
            <p class="text-gray-600 dark:text-gray-400">
              {categoryInfo[key].description}
            </p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {allImages.map((image, index) => (
              <button
                type="button"
                class="portfolio-photo group relative aspect-[4/3] overflow-hidden rounded-lg cursor-pointer text-left w-full border-0 p-0"
                data-category={key}
                data-index={index}
                data-image={image.src}
                data-alt={image.alt}
                data-caption={image.caption || ''}
                data-location={image.location || ''}
              >
                <img
                  src={image.src}
                  alt={image.alt}
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                />
                {image.caption && (
                  <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
                      <p class="text-sm font-medium">{image.caption}</p>
                      {image.location && (
                        <p class="text-xs text-gray-300">{image.location}</p>
                      )}
                    </div>
                  </div>
                )}
              </button>
            ))}
          </div>
        </section>
      );
    })}

    {/* Show message if no galleries in selected category */}
    {currentCategory && categories[currentCategory].length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400">
          No galleries found in this category.
        </p>
      </div>
    )}
  </div>

  <!-- Lightbox Component -->
  <Lightbox />
</BaseLayout>

<script>
  // Portfolio lightbox functionality
  function initPortfolioPhotos() {
    const portfolioPhotoButtons = document.querySelectorAll('.portfolio-photo');

    // Group photos by category
    const photosByCategory: Record<string, Array<{
      image: string;
      alt: string;
      title: string;
      location?: string;
      description?: string;
    }>> = {};

    portfolioPhotoButtons.forEach((button) => {
      const btn = button as HTMLButtonElement;
      const category = btn.dataset.category || '';
      const photoData = {
        image: btn.dataset.image || '',
        alt: btn.dataset.alt || '',
        title: btn.dataset.caption || '',
        location: btn.dataset.location || '',
        description: '', // Portfolio photos don't have descriptions
      };

      if (!photosByCategory[category]) {
        photosByCategory[category] = [];
      }
      photosByCategory[category].push(photoData);
    });

    // Add click handlers
    portfolioPhotoButtons.forEach((photo) => {
      photo.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const category = button.dataset.category || '';
        const clickedIndex = parseInt(button.dataset.index || '0', 10);

        if ((window as any).openLightbox && photosByCategory[category]) {
          (window as any).openLightbox(photosByCategory[category], clickedIndex);
        }
      });
    });
  }

  // Initialize on page load
  initPortfolioPhotos();

  // Re-initialize on navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initPortfolioPhotos);
</script>
