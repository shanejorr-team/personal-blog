---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import Lightbox from '../../components/Lightbox.astro';
import PhotoGridItem from '../../components/PhotoGridItem.astro';
import { getAllCategoryPhotos, getAllCategories } from '../../utils/db';
import { processPhotos } from '../../utils/processPhotos';
import { CATEGORY_INFO } from '../../utils/categories';

// Get all categories
const allCategories = getAllCategories();

// Pre-process categories with dimensions
const processedCategories = await Promise.all(
  allCategories.map(async (category) => {
    // Get featured photos for this category from database (limit to first 6)
    const photos = getAllCategoryPhotos(category).slice(0, 6);

    // Skip category if no featured photos
    if (photos.length === 0) return null;

    const images = await processPhotos(photos);
    return { key: category, images };
  })
).then(results => results.filter(Boolean) as { key: string; images: Awaited<ReturnType<typeof processPhotos>> }[]);
---

<BaseLayout
  title="Photography Portfolio"
  description="Browse curated collections of nature, street, and concert photography."
>
  <div class="container mx-auto px-4 py-12">
    <Breadcrumbs items={[{ label: 'Portfolio' }]} />

    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Photography Portfolio</h1>
      <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Curated collections of my best work
      </p>
    </div>

    <div class="mb-12">
      <h3 class="text-lg font-semibold text-center mb-4">Browse by Photo Type</h3>
      <div class="flex flex-wrap gap-4 justify-center">
        {Object.entries(CATEGORY_INFO).map(([key, info]) => (
          <a
            href={`/portfolio/${key}`}
            class="px-6 py-3 rounded-lg font-medium transition-colors bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            {info.title}
          </a>
        ))}
      </div>
      <div class="flex justify-center mt-4">
        <a
          href="/portfolio/all-countries"
          class="px-8 py-3 rounded-lg font-medium transition-colors bg-sky-200 text-black hover:bg-sky-300"
        >
          Browse by Country
        </a>
      </div>
    </div>

    {processedCategories.map(({ key, images }) => (
      <section class="mb-20" id={key}>
        <div class="mb-8 flex justify-between items-end">
          <div>
            <h2 class="text-3xl font-bold mb-2">{CATEGORY_INFO[key].title}</h2>
            <p class="text-gray-600 dark:text-gray-400">
              {CATEGORY_INFO[key].description}
            </p>
          </div>
          <a
            href={`/portfolio/${key}`}
            class="text-blue-600 dark:text-blue-400 hover:underline font-medium whitespace-nowrap"
          >
            View All â†’
          </a>
        </div>

        <div class="flex flex-wrap gap-4 justify-start">
          {images.map((image, index) => (
            <PhotoGridItem image={image} index={index} groupKey={key} />
          ))}
        </div>
      </section>
    ))}
  </div>

  <Lightbox />
</BaseLayout>
