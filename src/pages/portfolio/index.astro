---
import { getCollection } from 'astro:content';
import { Image, getImage } from 'astro:assets';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import Lightbox from '../../components/Lightbox.astro';
import { getImageByPath } from '../../utils/imageLoader';

// Get all portfolio collections
const allPortfolio = await getCollection('portfolio');
const sortedPortfolio = allPortfolio.sort((a, b) => a.data.order - b.data.order);

// Group by category
const categories = {
  nature: sortedPortfolio.filter(p => p.data.category === 'nature'),
  street: sortedPortfolio.filter(p => p.data.category === 'street'),
  concert: sortedPortfolio.filter(p => p.data.category === 'concert'),
  other: sortedPortfolio.filter(p => p.data.category === 'other'),
};

const categoryInfo = {
  nature: {
    title: 'Nature',
    description: 'Landscapes, wildlife, and natural wonders',
  },
  street: {
    title: 'Street Photography',
    description: 'Candid moments and urban life',
  },
  concert: {
    title: 'Concert Photography',
    description: 'Live music and performance',
  },
  other: {
    title: 'Other',
    description: 'Various photography projects',
  },
};

// Extract all unique countries
const countriesSet = new Set<string>();
allPortfolio.forEach(portfolio => {
  portfolio.data.images.forEach(image => {
    if (image.country) {
      countriesSet.add(image.country);
    }
  });
});
const countries = Array.from(countriesSet).sort();

// Pre-process categories with dimensions
const processedCategories = await Promise.all(
  Object.entries(categories).map(async ([categoryKey, galleries]) => {
    const key = categoryKey as keyof typeof categories;
    if (galleries.length === 0) return null;

    // Flatten all images from all galleries in this category and filter for featured
    const allImagesWithDimensions = await Promise.all(
      galleries.flatMap((gallery, galleryIndex) =>
        gallery.data.images
          .filter(image => image.featured === true)
          .map(async (image, imageIndex) => {
            // Get imported image from src/images
            const importedImage = getImageByPath(image.src);

            if (!importedImage) {
              console.warn(`Could not find imported image for ${image.src}`);
              return {
                ...image,
                galleryId: gallery.id,
                galleryIndex,
                imageIndex,
                aspectRatio: 1.5,
                lightboxSrc: image.src,
                originalSrc: image.src,
                importedImage: undefined,
              };
            }

            // Get aspect ratio from imported image metadata
            const aspectRatio = importedImage.width / importedImage.height;

            // Generate optimized lightbox version (skip for SVG files)
            const isSvg = image.src.toLowerCase().endsWith('.svg');
            let lightboxSrc = image.src;

            if (!isSvg) {
              try {
                // Calculate target height based on aspect ratio
                const targetHeight = Math.round(1920 / aspectRatio);

                const lightboxImage = await getImage({
                  src: importedImage,
                  width: 1920,
                  height: targetHeight,
                  format: 'webp',
                  quality: 85,
                });
                lightboxSrc = lightboxImage.src;
              } catch (error) {
                console.warn(`Could not optimize lightbox image for ${image.src}:`, error.message);
                // Fall back to original image
                lightboxSrc = image.src;
              }
            }

            return {
              ...image,
              galleryId: gallery.id,
              galleryIndex,
              imageIndex,
              aspectRatio,
              lightboxSrc,
              originalSrc: image.src,
              importedImage,
            };
          })
      )
    );

    // Skip category if no featured images
    if (allImagesWithDimensions.length === 0) return null;

    return { key, images: allImagesWithDimensions };
  })
).then(results => results.filter(Boolean)); // Remove nulls
---

<BaseLayout
  title="Photography Portfolio"
  description="Browse curated collections of nature, street, and concert photography."
>
  <div class="container mx-auto px-4 py-12">
    <Breadcrumbs items={[{ label: 'Portfolio' }]} />

    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Photography Portfolio</h1>
      <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Curated collections of my best work
      </p>
    </div>

    <!-- Category Filter -->
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-center mb-4">Browse by Photo Type</h3>
      <div class="flex flex-wrap gap-4 justify-center">
        {Object.entries(categoryInfo).map(([key, info]) => (
          <a
            href={`/portfolio/${key}`}
            class="px-6 py-3 rounded-lg font-medium transition-colors bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            {info.title}
          </a>
        ))}
      </div>
    </div>

    <!-- Country Filter -->
    {countries.length > 0 && (
      <div class="mb-12">
        <h3 class="text-lg font-semibold text-center mb-4">Browse by Country</h3>
        <div class="flex flex-wrap gap-4 justify-center">
          {countries.map(country => (
            <a
              href={`/portfolio/${country.toLowerCase().replace(/\s+/g, '-')}`}
              class="px-6 py-3 rounded-lg font-medium transition-colors bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
            >
              {country}
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Portfolio Galleries -->
    {processedCategories.map(({ key, images: allImages }) => (
        <section class="mb-20" id={key}>
          <div class="mb-8 flex justify-between items-end">
            <div>
              <h2 class="text-3xl font-bold mb-2">{categoryInfo[key].title}</h2>
              <p class="text-gray-600 dark:text-gray-400">
                {categoryInfo[key].description}
              </p>
            </div>
            <a
              href={`/portfolio/${key}`}
              class="text-blue-600 dark:text-blue-400 hover:underline font-medium whitespace-nowrap"
            >
              View All â†’
            </a>
          </div>

          <!-- Justified grid layout -->
          <div class="flex flex-wrap gap-4 justify-start">
            {allImages.map((image, index) => {
              // Calculate flex-basis based on aspect ratio
              // Target row height of ~280px, adjust width based on aspect ratio
              const targetHeight = 280;
              const flexBasis = targetHeight * image.aspectRatio;

              return (
                <button
                  type="button"
                  class="portfolio-photo group relative overflow-hidden rounded-lg cursor-pointer text-left border-0 p-0 bg-transparent flex-grow-0"
                  style={`flex-basis: ${flexBasis}px; height: ${targetHeight}px;`}
                  data-category={key}
                  data-index={index}
                  data-lightbox-src={image.lightboxSrc}
                  data-original-src={image.originalSrc}
                  data-alt={image.alt}
                  data-caption={image.caption || ''}
                  data-location={image.location || ''}
                >
                  <Image
                    src={image.importedImage || image.src}
                    alt={image.alt}
                    width={Math.round(flexBasis * 2)}
                    height={Math.round(targetHeight * 2)}
                    format="webp"
                    quality={80}
                    class="w-full h-full object-cover rounded-lg transition-transform duration-300 group-hover:scale-110"
                    loading="lazy"
                  />
                  {image.caption && (
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg">
                    <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
                      <p class="text-sm font-medium">{image.caption}</p>
                      {image.location && (
                        <p class="text-xs text-gray-300">{image.location}</p>
                      )}
                    </div>
                  </div>
                  )}
                </button>
              );
            })}
          </div>
        </section>
    ))}
  </div>

  <!-- Lightbox Component -->
  <Lightbox />
</BaseLayout>

<script>
  // Portfolio lightbox functionality
  function initPortfolioPhotos() {
    const portfolioPhotoButtons = document.querySelectorAll('.portfolio-photo');

    // Group photos by category
    const photosByCategory: Record<string, Array<{
      image: string;
      original: string;
      alt: string;
      title: string;
      location?: string;
      description?: string;
    }>> = {};

    portfolioPhotoButtons.forEach((button) => {
      const btn = button as HTMLButtonElement;
      const category = btn.dataset.category || '';
      const photoData = {
        image: btn.dataset.lightboxSrc || '',
        original: btn.dataset.originalSrc || '',
        alt: btn.dataset.alt || '',
        title: btn.dataset.caption || '',
        location: btn.dataset.location || '',
        description: '', // Portfolio photos don't have descriptions
      };

      if (!photosByCategory[category]) {
        photosByCategory[category] = [];
      }
      photosByCategory[category].push(photoData);
    });

    // Add click handlers
    portfolioPhotoButtons.forEach((photo) => {
      photo.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const category = button.dataset.category || '';
        const clickedIndex = parseInt(button.dataset.index || '0', 10);

        if ((window as any).openLightbox && photosByCategory[category]) {
          (window as any).openLightbox(photosByCategory[category], clickedIndex);
        }
      });
    });
  }

  // Initialize on page load
  initPortfolioPhotos();

  // Re-initialize on navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initPortfolioPhotos);
</script>
