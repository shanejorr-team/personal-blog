---
import { Image, getImage } from 'astro:assets';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import Lightbox from '../../components/Lightbox.astro';
import { getImageByPath } from '../../utils/imageLoader';
import { getAllCountries, getCountryPhotos, getPhotoPath } from '../../utils/db';

export async function getStaticPaths() {
  // Get all countries from database
  const countries = getAllCountries();

  return countries.map(country => ({
    params: { country: country.toLowerCase().replace(/\s+/g, '-') },
    props: { country },
  }));
}

const { country } = Astro.props;

// Get all photos for this country from database
const photos = getCountryPhotos(country);

// Process photos with dimensions
const countryImages = await Promise.all(
  photos.map(async (photo) => {
    const imagePath = getPhotoPath(photo);

    // Get imported image from src/images
    const importedImage = getImageByPath(imagePath);

    if (!importedImage) {
      console.warn(`Could not find imported image for ${imagePath}`);
      return {
        src: imagePath,
        alt: photo.alt,
        caption: photo.caption,
        location: photo.location,
        aspectRatio: 1.5,
        lightboxSrc: imagePath,
        originalSrc: imagePath,
        importedImage: undefined,
      };
    }

    // Get aspect ratio from imported image metadata
    const aspectRatio = importedImage.width / importedImage.height;

    // Generate optimized lightbox version (skip for SVG files)
    const isSvg = imagePath.toLowerCase().endsWith('.svg');
    let lightboxSrc = imagePath;

    if (!isSvg) {
      try {
        // Calculate target height based on aspect ratio
        const targetHeight = Math.round(1920 / aspectRatio);

        const lightboxImage = await getImage({
          src: importedImage,
          width: 1920,
          height: targetHeight,
          format: 'webp',
          quality: 85,
        });
        lightboxSrc = lightboxImage.src;
      } catch (error) {
        console.warn(`Could not optimize lightbox image for ${imagePath}:`, error.message);
        // Fall back to original image
        lightboxSrc = imagePath;
      }
    }

    return {
      src: imagePath,
      alt: photo.alt,
      caption: photo.caption,
      location: photo.location,
      aspectRatio,
      lightboxSrc,
      originalSrc: imagePath,
      importedImage,
    };
  })
);

// Group images by location
const imagesByLocation = countryImages.reduce((acc, image) => {
  const location = image.location || 'Other';
  if (!acc[location]) {
    acc[location] = [];
  }
  acc[location].push(image);
  return acc;
}, {} as Record<string, typeof countryImages>);

// Sort locations alphabetically
const sortedLocations = Object.entries(imagesByLocation).sort((a, b) =>
  a[0].localeCompare(b[0])
);
---

<BaseLayout
  title={`${country} - Photography Portfolio`}
  description={`Browse my photography from ${country}, organized by location.`}
>
  <div class="container mx-auto px-4 py-12">
    <Breadcrumbs items={[
      { label: 'Portfolio', href: '/portfolio' },
      { label: country }
    ]} />

    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">{country}</h1>
      <p class="text-xl text-gray-600 dark:text-gray-400">
        {countryImages.length} {countryImages.length === 1 ? 'photo' : 'photos'} from {sortedLocations.length} {sortedLocations.length === 1 ? 'location' : 'locations'}
      </p>
    </div>

    <!-- Images grouped by location -->
    {sortedLocations.map(([location, images]) => {
      // Images already have aspectRatio from Sharp metadata
      const locationImages = images.map((image, index) => ({
        ...image,
        index,
      }));

      return (
        <section class="mb-16" id={location.toLowerCase().replace(/\s+/g, '-')}>
          <div class="mb-6">
            <h2 class="text-3xl font-bold">{location}</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
              {images.length} {images.length === 1 ? 'photo' : 'photos'}
            </p>
          </div>

          <!-- Justified grid layout -->
          <div class="flex flex-wrap gap-4 justify-start">
            {locationImages.map((image, index) => {
              // Calculate flex-basis based on aspect ratio
              // Target row height of ~280px, adjust width based on aspect ratio
              const targetHeight = 280;
              const flexBasis = targetHeight * image.aspectRatio;

              return (
                <button
                  type="button"
                  class="country-photo group relative overflow-hidden rounded-lg cursor-pointer text-left border-0 p-0 bg-transparent flex-grow-0"
                  style={`flex-basis: ${flexBasis}px; height: ${targetHeight}px;`}
                  data-location={location}
                  data-index={index}
                  data-lightbox-src={image.lightboxSrc}
                  data-original-src={image.originalSrc}
                  data-alt={image.alt}
                  data-caption={image.caption || ''}
                  data-location-name={image.location || ''}
                >
                  <Image
                    src={image.importedImage || image.src}
                    alt={image.alt}
                    width={Math.round(flexBasis * 2)}
                    height={Math.round(targetHeight * 2)}
                    format="webp"
                    quality={80}
                    class="w-full h-full object-cover rounded-lg transition-transform duration-300 group-hover:scale-110"
                    loading="lazy"
                  />
                  {image.caption && (
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg">
                      <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
                        <p class="text-sm font-medium">{image.caption}</p>
                        {image.location && (
                          <p class="text-xs text-gray-300">{image.location}</p>
                        )}
                      </div>
                    </div>
                  )}
                </button>
              );
            })}
          </div>
        </section>
      );
    })}

    {/* Show message if no photos found */}
    {countryImages.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400">
          No photos found for {country}.
        </p>
      </div>
    )}
  </div>

  <!-- Lightbox Component -->
  <Lightbox />
</BaseLayout>

<script>
  // Country page lightbox functionality
  function initCountryPhotos() {
    const countryPhotoButtons = document.querySelectorAll('.country-photo');

    // Group photos by location
    const photosByLocation: Record<string, Array<{
      image: string;
      original: string;
      alt: string;
      title: string;
      location?: string;
      description?: string;
    }>> = {};

    countryPhotoButtons.forEach((button) => {
      const btn = button as HTMLButtonElement;
      const location = btn.dataset.location || '';
      const photoData = {
        image: btn.dataset.lightboxSrc || '',
        original: btn.dataset.originalSrc || '',
        alt: btn.dataset.alt || '',
        title: btn.dataset.caption || '',
        location: btn.dataset.locationName || '',
        description: '', // Country photos don't have descriptions
      };

      if (!photosByLocation[location]) {
        photosByLocation[location] = [];
      }
      photosByLocation[location].push(photoData);
    });

    // Add click handlers
    countryPhotoButtons.forEach((photo) => {
      photo.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const location = button.dataset.location || '';
        const clickedIndex = parseInt(button.dataset.index || '0', 10);

        if ((window as any).openLightbox && photosByLocation[location]) {
          (window as any).openLightbox(photosByLocation[location], clickedIndex);
        }
      });
    });
  }

  // Initialize on page load
  initCountryPhotos();

  // Re-initialize on navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initCountryPhotos);
</script>
