---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import Lightbox from '../../components/Lightbox.astro';
import PhotoGridItem from '../../components/PhotoGridItem.astro';
import { getAllCountries, getCountryPhotos } from '../../utils/db';
import { processPhotos } from '../../utils/processPhotos';

export async function getStaticPaths() {
  const countries = getAllCountries();
  return countries.map(country => ({
    params: { country: country.toLowerCase().replace(/\s+/g, '-') },
    props: { country },
  }));
}

const { country } = Astro.props;

// Get and process photos
const photos = getCountryPhotos(country);
const countryImages = await processPhotos(photos);

// Group images by location
const imagesByLocation = countryImages.reduce((acc, image) => {
  const location = image.location || 'Other';
  if (!acc[location]) {
    acc[location] = [];
  }
  acc[location].push(image);
  return acc;
}, {} as Record<string, typeof countryImages>);

// Sort locations alphabetically
const sortedLocations = Object.entries(imagesByLocation).sort((a, b) =>
  a[0].localeCompare(b[0])
);
---

<BaseLayout
  title={`${country} - Photography Portfolio`}
  description={`Browse my photography from ${country}, organized by location.`}
>
  <div class="container mx-auto px-4 py-12">
    <Breadcrumbs items={[
      { label: 'Portfolio', href: '/portfolio' },
      { label: country }
    ]} />

    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">{country}</h1>
    </div>

    {sortedLocations.map(([location, images]) => (
      <section class="mb-16" id={location.toLowerCase().replace(/\s+/g, '-')}>
        <div class="mb-6">
          <h2 class="text-3xl font-bold">{location}</h2>
        </div>

        <div class="flex flex-wrap gap-4 justify-start">
          {images.map((image, index) => (
            <PhotoGridItem image={image} index={index} groupKey={location} />
          ))}
        </div>
      </section>
    ))}

    {countryImages.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400">
          No photos found for {country}.
        </p>
      </div>
    )}
  </div>

  <Lightbox />
</BaseLayout>
